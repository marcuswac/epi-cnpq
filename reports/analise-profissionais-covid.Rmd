---
title: "Análise de profissionais em unidades de saúde com notificações para a COVID-19"
author: "Marcus Carvalho"
date: "02/10/2020"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(DT)
library(here)
library(readr)
library(RMySQL)
library(stringr)
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}
cnes_dir <- "~/local/datasets/dados-sus/BASE_DE_DADOS_CNES"

# srag_covid <- here("data/srag_covid_notificacoes_resumo.csv") %>%
#   read_csv()
# 
# prof_sus <- file.path(cnes_dir, "tbDadosProfissionalSus202009.csv") %>%
#   read_csv2()
# 
# estabelecimento <- file.path(cnes_dir, "tbEstabelecimento202009.csv") %>%
#   read_csv2(col_types = cols("CO_UNIDADE" = col_character()))
# 
# carga_horaria_sus <- file.path(cnes_dir, "tbCargaHorariaSus202009.csv") %>%
#   read_csv2()
# 
# atividade_prof <- file.path(cnes_dir, "tbAtividadeProfissional202009.csv") %>%
#   read_csv2(col_types = cols("CO_CBO" = col_character()))

estabelecimento_covid <- here("data/srag_covid_notificacoes_resumo.csv") %>%
  read_csv() %>%
  left_join(
    read_csv2(file.path(cnes_dir, "tbEstabelecimento202009.csv"),
              col_types = cols("CO_UNIDADE" = "c")),
    by = "NO_FANTASIA"
  ) %>%
  left_join(
    read_csv2(file.path(cnes_dir, "tbCargaHorariaSus202009.csv")),
    by = "CO_UNIDADE") %>%
  left_join(
    read_csv2(file.path(cnes_dir, "tbDadosProfissionalSus202009.csv")),
    by = "CO_PROFISSIONAL_SUS") %>%
  left_join(
    read_csv2(file.path(cnes_dir, "tbAtividadeProfissional202009.csv"),
              col_types = cols("CO_CBO" = "c"))
  )
    

#rm(srag_covid, prof_sus, estabelecimento, )
```

```{r}
prof_covid_uf <- estabelecimento_covid %>%
  filter(!is.na(DS_ATIVIDADE_PROFISSIONAL)) %>%
  group_by(UF) %>%
  summarise(`Qtd profissionais` = n())
```

### Quantidade de profissionais atuando em estabelecimentos de saúde que notificam casos de Covid-19 por estado

```{r, warning=FALSE}
DT::datatable(
  prof_covid_uf,
  filter = "top",
  extensions = 'Buttons',
  options = list(
    dom = 'Bfrtip',
    buttons = c('csv', 'excel', 'pdf')
  )
)
```

```{r, include=FALSE}
prof_covid <- estabelecimento_covid %>%
  filter(!is.na(DS_ATIVIDADE_PROFISSIONAL)) %>%
  group_by(UF,
           Municipio = MUNICIPIO,
           Unidade = NO_FANTASIA,
           `Atividade profissional` = DS_ATIVIDADE_PROFISSIONAL) %>%
  summarise(`Qtd profissionais` = n(),
            `Notificações COVID total da unidade` = first(notificacoes)) %>%
  arrange(desc(`Notificações COVID total da unidade`), desc(`Qtd profissionais`))

#write_csv2(prof_covid, here("data/profissionais_unidades_covid.csv"))
```

### Estabelecimentos de saúde com a quantidade de profissionais de saúde por atividade profissional e a quantidade de notificações de Covid-19 realizadas pelo estabelecimento

```{r, warning=FALSE}
DT::datatable(
  prof_covid,
  filter = "top",
  extensions = 'Buttons',
  options = list(
    dom = 'Bfrtip',
    buttons = c('csv', 'excel', 'pdf')
  )
)
```

## Método

São usadas duas bases de dados do Ministério da Saúde:

- [Cadastro Nacional dos Estalabecimentos de Saúde](http://cnes.datasus.gov.br/pages/downloads/arquivosBaseDados.jsp) (**CNES**): para cada estabelecimento de saúde, contém informações sobre a quantidade de profissionais que trabalham na unidade por atividade profissional.
- [Banco de dados de Síndrome Respiratórioa Aguda Grave](https://opendatasus.saude.gov.br/dataset/bd-srag-2020) (**SRAG**): contém informações de notificações de casos de Covid-19 e internações, indicando qual estabelecimento de realizou a notificação do caso.

Para os dados do CNES, foi calculada a quantidade de profissionais de saúde que atuam em cada estabelecimento de saúde, agrupado por atividade profissional.
Para os dados de SRAG, foi calculada a quantidade de notificações de Covid-19 realizadas por cada estabelecimento de saúde.

Após os cálculos individuais em cada tabela, foi feita uma junção das duas tabelas e a tabela resultante foi apresentada neste relatório.
